<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PeeragogyBot - Embed</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Base Colors (can be overridden by JS) */
            --gradient-start: #6366f1;
            --gradient-mid: #3b82f6;
            --gradient-end: #8b5cf6;
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --text-color: #ffffff;
            --loader-color: #ffffff;
            --font-family: 'Inter', sans-serif;

             /* Flowise Theme Overrides (can be customized via JS) */
            --flowise-user-msg-bg: #3B81F6;
            --flowise-user-msg-text: #ffffff;
            --flowise-bot-msg-bg: #f1f1f1; /* Default, customize if needed */
            --flowise-bot-msg-text: #303030; /* Default, customize if needed */
            --flowise-input-placeholder: #555;
            --flowise-send-button: #3B81F6;
            --flowise-footer-text: #aaa;
            --flowise-footer-link: #3B81F6;
            --flowise-chatbot-bg: #ffffff; /* Chatbot window background */
        }

        html,
        body {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            font-family: var(--font-family);
            background-color: #1a1a1e; /* Dark fallback */
            overflow: hidden; /* Prevent scrollbars on body */
            position: relative; /* For absolute positioning of loader */
        }

        body::before {
            content: '';
            position: fixed; /* Use fixed to cover viewport even if body scrolls (though we prevent it) */
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: 0;
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-mid), var(--gradient-end));
            background-size: 400% 400%;
            animation: gradient-animation 18s ease infinite;
        }

        @keyframes gradient-animation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        #chatbot-container {
            position: absolute; /* Use absolute to position relative to body */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex; /* Center loader initially */
            align-items: center;
            justify-content: center;
            padding: 1rem; /* Add some padding around the glass container */
            box-sizing: border-box; /* Include padding in width/height */
        }

        #glass-wrapper {
            position: relative; /* Contain the bot */
            width: 100%;
            height: 100%;
            background: var(--glass-bg);
            backdrop-filter: blur(10px) saturate(150%);
            -webkit-backdrop-filter: blur(10px) saturate(150%); /* Safari */
            border-radius: 16px; /* Slightly softer radius */
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            overflow: hidden; /* Crucial for keeping Flowise inside */
            z-index: 1; /* Above the background gradient */
            animation: scaleIn 0.7s cubic-bezier(0.165, 0.84, 0.44, 1) forwards;
            opacity: 0; /* Start hidden for animation */
        }

        @keyframes scaleIn {
            0% { opacity: 0; transform: scale(0.95); }
            100% { opacity: 1; transform: scale(1); }
        }

        /* Loading Spinner */
        #loading-spinner {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--loader-color);
            animation: spin 1s ease-in-out infinite;
            z-index: 2; /* Above glass wrapper initially */
            transition: opacity 0.5s ease;
        }

        @keyframes spin {
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }

        /* Hide loader when bot is ready */
        #chatbot-container.loaded #loading-spinner {
            opacity: 0;
            pointer-events: none; /* Prevent interaction */
        }

        /* Flowise target container */
        #flowise-embed-target {
            width: 100%;
            height: 100%;
            opacity: 0; /* Start hidden */
            transition: opacity 0.6s ease 0.2s; /* Fade in slightly after container animates */
        }

         /* Show bot when loaded */
        #chatbot-container.loaded #flowise-embed-target {
            opacity: 1;
        }

        /* Flowise Custom Element Styling (using CSS vars) */
        flowise-chatbot {
            /* You might need !important if Flowise internal styles are too specific */
            --user-message-bg: var(--flowise-user-msg-bg);
            --user-message-text: var(--flowise-user-msg-text);
            --chat-window-bg-color: var(--flowise-chatbot-bg);
            --bot-message-bg: var(--flowise-bot-msg-bg);
            --bot-message-text: var(--flowise-bot-msg-text);
            --input-placeholder: var(--flowise-input-placeholder);
            --send-button-color: var(--flowise-send-button);
            --footer-text-color: var(--flowise-footer-text);
            --company-link-color: var(--flowise-footer-link);
            --font-family: var(--font-family); /* Ensure font propagates */
            /* You might need to target specific inner elements if CSS vars aren't fully supported */
        }

         /* Retina / High DPI adjustments (Example) */
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            /* Thinner border for glass effect on high DPI might look sharper */
            #glass-wrapper {
                 /* border-width: 0.5px; */ /* Uncomment if needed */
            }
            /* You could potentially load higher-res avatar images here if needed */
        }

    </style>
</head>

<body>
    <div id="chatbot-container">
        <div id="loading-spinner"></div>
        <div id="glass-wrapper">
            <div id="flowise-embed-target"></div>
        </div>
    </div>

    <script type="module">
        async function initializeChatbot() {
            const chatbotContainer = document.getElementById("chatbot-container");
            const flowiseTarget = document.getElementById("flowise-embed-target");
            const loadingSpinner = document.getElementById("loading-spinner");

            // --- Configuration ---
            const params = new URLSearchParams(window.location.search);

            const config = {
                // --- Core Flowise Config ---
                // !! IMPORTANT: Replace with your ACTUAL Chatflow ID and API Host !!
                chatflowid: params.get("chatflowid") || "9c913bf8-5526-4e53-bd16-d9ed392f47a8", // Example ID
                apiHost: params.get("apiHost") || "https://peeragogybot-flowise-production-68ec.up.railway.app", // Example Host

                // --- Theme & Customization (with URL overrides) ---
                theme: {
                    chatWindow: {
                        // We don't need a title bar in embed, Flowise handles it internally
                        // showTitle: false,
                        welcomeMessage: params.get("welcomeMessage") || "Hi there ðŸ‘‹ I'm PeeragogyBot. How can I assist with your co-learning journey today?",
                        backgroundColor: params.get("bgColor") || getComputedStyle(document.documentElement).getPropertyValue('--flowise-chatbot-bg').trim(),
                        height: "100%", // Ensure it fills the container
                        width: "100%",
                        fontSize: 15, // Slightly smaller for embed
                        poweredByTextColor: params.get("poweredByColor") || getComputedStyle(document.documentElement).getPropertyValue('--flowise-footer-text').trim(),
                    },
                    botMessage: {
                        showAvatar: params.get("showBotAvatar") !== "false", // default true
                        avatarSrc: params.get("botAvatar") || "https://raw.githubusercontent.com/Peeragogy/PeeragogyBot/main/assets/images/peeragogy-icon-blue.svg", // Use your logo or a futuristic avatar
                        backgroundColor: params.get("botMsgBg") || getComputedStyle(document.documentElement).getPropertyValue('--flowise-bot-msg-bg').trim(),
                        textColor: params.get("botMsgText") || getComputedStyle(document.documentElement).getPropertyValue('--flowise-bot-msg-text').trim(),
                    },
                    userMessage: {
                        showAvatar: params.get("showUserAvatar") !== "false", // default true
                        avatarSrc: params.get("userAvatar") || "https://raw.githubusercontent.com/zahidkhawaja/langchain-chat-nextjs/main/public/usericon.png",
                        backgroundColor: params.get("userMsgBg") || getComputedStyle(document.documentElement).getPropertyValue('--flowise-user-msg-bg').trim(),
                        textColor: params.get("userMsgText") || getComputedStyle(document.documentElement).getPropertyValue('--flowise-user-msg-text').trim(),
                    },
                    textInput: {
                        placeholder: params.get("inputPlaceholder") || "Ask about Peeragogy...",
                        backgroundColor: "#ffffff",
                        textColor: "#303030",
                        sendButtonColor: params.get("sendBtnColor") || getComputedStyle(document.documentElement).getPropertyValue('--flowise-send-button').trim(),
                    },
                    // Footer can be simplified or removed for embed
                     footer: {
                         // text: "Powered by",
                         // company: "Flowise",
                         // companyLink: "https://flowiseai.com",
                         // Optional: Keep simplified footer
                         text: params.get("footerText") || "PeeragogyBot", // Shorter footer
                         company: "",
                         companyLink: "",
                     }
                }
            };

            // --- Apply Gradient Customization (if URL params exist) ---
            const gradientStart = params.get("gradientStart");
            const gradientMid = params.get("gradientMid");
            const gradientEnd = params.get("gradientEnd");
            if (gradientStart || gradientMid || gradientEnd) {
                 document.documentElement.style.setProperty('--gradient-start', gradientStart || getComputedStyle(document.documentElement).getPropertyValue('--gradient-start').trim());
                 document.documentElement.style.setProperty('--gradient-mid', gradientMid || getComputedStyle(document.documentElement).getPropertyValue('--gradient-mid').trim());
                 document.documentElement.style.setProperty('--gradient-end', gradientEnd || getComputedStyle(document.documentElement).getPropertyValue('--gradient-end').trim());
            }
             const glassBg = params.get("glassBg");
             const glassBorder = params.get("glassBorder");
             if (glassBg) document.documentElement.style.setProperty('--glass-bg', glassBg);
             if (glassBorder) document.documentElement.style.setProperty('--glass-border', glassBorder);


            // --- Load Flowise ---
            try {
                // Dynamically import Flowise Embed library
                const { default: Chatbot } = await import("https://cdn.jsdelivr.net/npm/flowise-embed/dist/web.js");

                // Initialize Flowise in the target div
                Chatbot.init({
                    ...config, // Spread the base config
                    elementId: "flowise-embed-target" // Target the inner div
                });

                // Add 'loaded' class to trigger CSS transitions/animations
                // Use a small timeout to ensure DOM updates from Flowise init happen first
                setTimeout(() => {
                     chatbotContainer.classList.add("loaded");
                }, 100); // Adjust timing if needed

            } catch (error) {
                console.error("Failed to load or initialize Flowise chatbot:", error);
                // Display an error message to the user within the embed
                flowiseTarget.innerHTML = `<p style="color: var(--text-color); padding: 20px; text-align: center;">Sorry, the chatbot couldn't be loaded. Please try again later.</p>`;
                chatbotContainer.classList.add("loaded"); // Still hide spinner, show error
            }
        }

        // Run initialization on page load
        document.addEventListener("DOMContentLoaded", initializeChatbot);

    </script>
</body>
</html>
