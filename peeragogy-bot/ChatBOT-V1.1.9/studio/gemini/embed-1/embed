<!DOCTYPE html>
<html lang="it"> {/* Modificato lang in 'it' visto che la richiesta √® in italiano */}

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PeeragogyBot - Embed</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Colori Base (sovrascrivibili via JS) */
            --gradient-start: #6366f1;
            --gradient-mid: #3b82f6;
            --gradient-end: #8b5cf6;
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --text-color: #ffffff;
            --loader-color: #ffffff;
            --font-family: 'Inter', sans-serif;

             /* Sovrascritture Tema Flowise (personalizzabili via JS) */
            --flowise-user-msg-bg: #3B81F6;
            --flowise-user-msg-text: #ffffff;
            --flowise-bot-msg-bg: #f1f1f1; /* Default, personalizza se necessario */
            --flowise-bot-msg-text: #303030; /* Default, personalizza se necessario */
            --flowise-input-placeholder: #555;
            --flowise-send-button: #3B81F6;
            --flowise-footer-text: #aaa;
            --flowise-footer-link: #3B81F6;
            --flowise-chatbot-bg: #ffffff; /* Sfondo finestra Chatbot */
        }

        html,
        body {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            font-family: var(--font-family);
            background-color: #1a1a1e; /* Fallback scuro */
            overflow: hidden; /* Previene scrollbar sul body */
            position: relative; /* Per posizionamento assoluto del loader */
        }

        body::before {
            content: '';
            position: fixed; /* Usa fixed per coprire il viewport */
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: 0;
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-mid), var(--gradient-end));
            background-size: 400% 400%;
            animation: gradient-animation 18s ease infinite;
        }

        @keyframes gradient-animation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        #chatbot-container {
            position: absolute; /* Posizione assoluta rispetto al body */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex; /* Centra il loader inizialmente */
            align-items: center;
            justify-content: center;
            padding: 1rem; /* Padding attorno al contenitore glass */
            box-sizing: border-box; /* Include padding in width/height */
        }

        #glass-wrapper {
            position: relative; /* Contiene il bot */
            width: 100%;
            height: 100%;
            background: var(--glass-bg);
            backdrop-filter: blur(10px) saturate(150%);
            -webkit-backdrop-filter: blur(10px) saturate(150%); /* Safari */
            border-radius: 16px; /* Raggio pi√π morbido */
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            overflow: hidden; /* Cruciale per mantenere Flowise dentro */
            z-index: 1; /* Sopra il gradiente di sfondo */
            animation: scaleIn 0.7s cubic-bezier(0.165, 0.84, 0.44, 1) forwards;
            opacity: 0; /* Inizia nascosto per animazione */
        }

        @keyframes scaleIn {
            0% { opacity: 0; transform: scale(0.95); }
            100% { opacity: 1; transform: scale(1); }
        }

        /* Loading Spinner */
        #loading-spinner {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--loader-color);
            animation: spin 1s ease-in-out infinite;
            z-index: 2; /* Sopra glass wrapper inizialmente */
            transition: opacity 0.5s ease;
        }

        @keyframes spin {
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }

        /* Nasconde loader quando il bot √® pronto */
        #chatbot-container.loaded #loading-spinner {
            opacity: 0;
            pointer-events: none; /* Previene interazione */
        }

        /* Contenitore target Flowise */
        #flowise-embed-target {
            width: 100%;
            height: 100%;
            opacity: 0; /* Inizia nascosto */
            transition: opacity 0.6s ease 0.2s; /* Fade in dopo l'animazione del container */
        }

         /* Mostra bot quando caricato */
        #chatbot-container.loaded #flowise-embed-target {
            opacity: 1;
        }

        /* Stile Custom Element Flowise (usando CSS vars) */
        flowise-chatbot {
            /* Potrebbe servire !important se gli stili interni di Flowise sono troppo specifici */
            --user-message-bg: var(--flowise-user-msg-bg);
            --user-message-text: var(--flowise-user-msg-text);
            --chat-window-bg-color: var(--flowise-chatbot-bg);
            --bot-message-bg: var(--flowise-bot-msg-bg);
            --bot-message-text: var(--flowise-bot-msg-text);
            --input-placeholder: var(--flowise-input-placeholder);
            --send-button-color: var(--flowise-send-button);
            --footer-text-color: var(--flowise-footer-text);
            --company-link-color: var(--flowise-footer-link);
            --font-family: var(--font-family); /* Assicura che il font si propaghi */
        }

         /* Adattamenti Retina / High DPI (Esempio) */
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            #glass-wrapper {
                 /* border-width: 0.5px; */ /* Decommenta se necessario */
            }
        }

    </style>
</head>

<body>
    <div id="chatbot-container">
        <div id="loading-spinner"></div>
        <div id="glass-wrapper">
            {/* Qui Flowise inietter√† il chatbot */}
            <div id="flowise-embed-target"></div>
        </div>
    </div>

    <script type="module">
        async function initializeChatbot() {
            const chatbotContainer = document.getElementById("chatbot-container");
            const flowiseTarget = document.getElementById("flowise-embed-target");
            const loadingSpinner = document.getElementById("loading-spinner");

            // --- Configurazione ---
            const params = new URLSearchParams(window.location.search);

            const config = {
                // --- Configurazione Core Flowise ---
                // !! IMPORTANTE: Sostituisci con il tuo VERO Chatflow ID e API Host !!
                chatflowid: params.get("chatflowid") || "9c913bf8-5526-4e53-bd16-d9ed392f47a8", // ID Esempio
                apiHost: params.get("apiHost") || "https://peeragogybot-flowise-production-68ec.up.railway.app", // Host Esempio

                // --- Tema & Personalizzazione (con override da URL) ---
                theme: {
                    chatWindow: {
                        welcomeMessage: params.get("welcomeMessage") || "Ciao üëã Sono PeeragogyBot. Come posso aiutarti nel tuo percorso di co-apprendimento oggi?", // Messaggio in italiano
                        backgroundColor: params.get("bgColor") || getComputedStyle(document.documentElement).getPropertyValue('--flowise-chatbot-bg').trim(),
                        height: "100%", // Riempie il container
                        width: "100%",
                        fontSize: 15, // Leggermente pi√π piccolo per embed
                        poweredByTextColor: params.get("poweredByColor") || getComputedStyle(document.documentElement).getPropertyValue('--flowise-footer-text').trim(),
                    },
                    botMessage: {
                        showAvatar: params.get("showBotAvatar") !== "false", // default true
                        avatarSrc: params.get("botAvatar") || "https://raw.githubusercontent.com/Peeragogy/PeeragogyBot/main/assets/images/peeragogy-icon-blue.svg", // Logo Peeragogy o altro avatar
                        backgroundColor: params.get("botMsgBg") || getComputedStyle(document.documentElement).getPropertyValue('--flowise-bot-msg-bg').trim(),
                        textColor: params.get("botMsgText") || getComputedStyle(document.documentElement).getPropertyValue('--flowise-bot-msg-text').trim(),
                    },
                    userMessage: {
                        showAvatar: params.get("showUserAvatar") !== "false", // default true
                        avatarSrc: params.get("userAvatar") || "https://raw.githubusercontent.com/zahidkhawaja/langchain-chat-nextjs/main/public/usericon.png", // Avatar utente generico
                        backgroundColor: params.get("userMsgBg") || getComputedStyle(document.documentElement).getPropertyValue('--flowise-user-msg-bg').trim(),
                        textColor: params.get("userMsgText") || getComputedStyle(document.documentElement).getPropertyValue('--flowise-user-msg-text').trim(),
                    },
                    textInput: {
                        placeholder: params.get("inputPlaceholder") || "Chiedi sulla Peeragogy...", // Placeholder in italiano
                        backgroundColor: "#ffffff",
                        textColor: "#303030",
                        sendButtonColor: params.get("sendBtnColor") || getComputedStyle(document.documentElement).getPropertyValue('--flowise-send-button').trim(),
                    },
                    footer: { // Footer semplificato per embed
                         text: params.get("footerText") || "PeeragogyBot",
                         company: "",
                         companyLink: "",
                    }
                }
            };

            // --- Applica Personalizzazione Gradiente (se parametri URL esistono) ---
            const gradientStart = params.get("gradientStart");
            const gradientMid = params.get("gradientMid");
            const gradientEnd = params.get("gradientEnd");
            if (gradientStart || gradientMid || gradientEnd) {
                 document.documentElement.style.setProperty('--gradient-start', gradientStart || getComputedStyle(document.documentElement).getPropertyValue('--gradient-start').trim());
                 document.documentElement.style.setProperty('--gradient-mid', gradientMid || getComputedStyle(document.documentElement).getPropertyValue('--gradient-mid').trim());
                 document.documentElement.style.setProperty('--gradient-end', gradientEnd || getComputedStyle(document.documentElement).getPropertyValue('--gradient-end').trim());
            }
             const glassBg = params.get("glassBg");
             const glassBorder = params.get("glassBorder");
             if (glassBg) document.documentElement.style.setProperty('--glass-bg', glassBg);
             if (glassBorder) document.documentElement.style.setProperty('--glass-border', glassBorder);


            // --- Carica Flowise ---
            try {
                // Importa dinamicamente la libreria Flowise Embed
                const { default: Chatbot } = await import("https://cdn.jsdelivr.net/npm/flowise-embed/dist/web.js");

                // Inizializza Flowise nel div target
                Chatbot.init({
                    ...config, // Usa la configurazione definita
                    elementId: "flowise-embed-target" // Targetizza il div interno
                });

                // Aggiunge la classe 'loaded' per triggerare transizioni/animazioni CSS
                // Usa un piccolo timeout per assicurare che gli aggiornamenti DOM da Flowise init avvengano prima
                setTimeout(() => {
                     chatbotContainer.classList.add("loaded");
                }, 100); // Aggiusta il timing se necessario

            } catch (error) {
                console.error("Impossibile caricare o inizializzare il chatbot Flowise:", error);
                // Mostra un messaggio di errore all'utente nell'embed
                flowiseTarget.innerHTML = `<p style="color: var(--text-color); padding: 20px; text-align: center;">Spiacenti, non √® stato possibile caricare il chatbot. Riprova pi√π tardi.</p>`;
                chatbotContainer.classList.add("loaded"); // Nasconde comunque lo spinner, mostra l'errore
            }
        }

        // Esegui l'inizializzazione al caricamento della pagina
        document.addEventListener("DOMContentLoaded", initializeChatbot);

    </script>
</body>
</html>
